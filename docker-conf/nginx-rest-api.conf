# rest_api.conf
# upstream definition
upstream api {
    ip_hash;
    server unix:/tmp/uwsgi.sock max_fails=5 fail_timeout=30s;
    keepalive 32;
}

map $request_method $purge_method {
    PURGE   1;
    default 0;
}

# configuration of the server
server {

    # the port your site will be served on, default_server indicates that this server block
    # is the block to use if no blocks match the server_name
    listen      80 default_server;
    listen      8008 ;

    # the domain name it will serve for
    # server_name .example.com; # substitute your machine's IP address or FQDN
    charset     utf-8;

    # max upload size
    client_max_body_size 75M;

    set $no_cache "0";#$http_clear_cache;
        if ($request_uri ~ .*request_token.*) {
                set $no_cache "1";
        }
        if ($request_uri ~ .*nocache.*) {
                set $no_cache "1";
        }



    location / { try_files $uri @rest_api; }
    location @rest_api {
        include uwsgi_params;
        uwsgi_pass api;
        uwsgi_read_timeout 5m;
        uwsgi_send_timeout 5m;
        uwsgi_request_buffering on;
        uwsgi_ignore_client_abort off;
        uwsgi_next_upstream error timeout;
        uwsgi_next_upstream_timeout 2m;
        uwsgi_next_upstream_tries 0;

        proxy_set_header   Host $host;
        proxy_set_header   X-Real-IP $remote_addr;
        proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Host $server_name;




        }

    location  /api/swagger/ {
        alias /var/www/swagger-ui/dist/;
    }

    location = /api-nginx-health {
        return 200;
        access_log off;
    }



}